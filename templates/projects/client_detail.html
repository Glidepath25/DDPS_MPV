{% extends 'base.html' %}
{% block title %}{{ object.name }} | DDPS{% endblock %}
{% block content %}
<div class='d-flex justify-content-between align-items-start mb-4'>
    <div>
        <h1 class='h3 mb-1'>{{ object.name }}</h1>
        <p class='text-muted mb-0'>Account code: {{ object.account_code }}</p>
        {% if object.address %}
        <p class='text-muted mb-0'>{{ object.address }}, {{ object.city }} {{ object.country }}</p>
        {% endif %}
    </div>
    <div class='text-end'>
        {% if request.user.role != 'client' %}
        <a class='btn btn-outline-primary' href='{% url 'project-create' %}?client={{ object.pk }}'>New project</a>
        {% endif %}
    </div>
</div>

<div class='row g-3 mb-4'>
    <div class='col-md-4'>
        <div class='card shadow-sm h-100'>
            <div class='card-body'>
                <h2 class='h6 text-uppercase text-muted'>Account manager</h2>
                {% if object.account_manager %}
                <p class='h5 mb-0'>{{ object.account_manager.get_full_name|default:object.account_manager.username }}</p>
                <p class='mb-0'><a href='mailto:{{ object.account_manager.email }}'>{{ object.account_manager.email }}</a></p>
                {% else %}
                <p class='mb-0 text-muted'>Not assigned</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class='col-md-4'>
        <div class='card shadow-sm h-100'>
            <div class='card-body'>
                <h2 class='h6 text-uppercase text-muted'>Revenue</h2>
                <p class='mb-1'>Actual: {% if request.user.can_view_finance %}<strong>&pound;{{ object.revenue_actual }}</strong>{% else %}<span class='text-muted'>Hidden</span>{% endif %}</p>
                <p class='mb-0'>Forecast: <strong>&pound;{{ object.revenue_forecast }}</strong></p>
            </div>
        </div>
    </div>
    <div class='col-md-4'>
        <div class='card shadow-sm h-100'>
            <div class='card-body'>
                <h2 class='h6 text-uppercase text-muted'>Approved contacts</h2>
                <ul class='list-unstyled mb-0'>
                    {% for access in object.access_assignments.all %}
                    <li class='mb-2'>
                        <strong>{{ access.user.get_full_name|default:access.user.username }}</strong><br>
                        <span class='text-muted small'>{{ access.user.email }}{% if access.role_title %} - {{ access.role_title }}{% endif %}</span>
                    </li>
                    {% empty %}
                    <li class='text-muted'>No contacts recorded.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<h2 class='h4 mb-3'>Jobs</h2>
<div class='table-responsive bg-white shadow-sm rounded'>
    <table class='table table-hover align-middle mb-0'>
        <thead>
            <tr>
                <th scope='col'>Project</th>
                <th scope='col'>Reference</th>
                <th scope='col'>Title</th>
                <th scope='col'>Owner</th>
                <th scope='col'>Status</th>
                <th scope='col'>Forecast &pound;</th>
                <th scope='col'>Actual &pound;</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr>
                <td><a href='{% url 'project-detail' job.project.pk %}'>{{ job.project.reference }}</a></td>
                <td><a href='{% url 'job-detail' job.pk %}'>{{ job.reference }}</a></td>
                <td>{{ job.title }}</td>
                <td>{% if job.owner %}{{ job.owner.get_full_name|default:job.owner.username }}{% else %}-{% endif %}</td>
                <td>{{ job.get_status_display }}</td>
                <td>&pound;{{ job.forecast_revenue }}</td>
                <td>{% if request.user.can_view_finance %}&pound;{{ job.actual_revenue }}{% else %}-{% endif %}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan='7' class='text-center py-4 text-muted'>No jobs recorded.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
